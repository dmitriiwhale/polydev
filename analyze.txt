#!/usr/bin/env node

/**
 * Polymarket Win Rate Analyzer (ALL-TIME VERSION)
 * Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ğ’Ğ¡Ğ• Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ ÑĞ¾ Ğ²ÑĞµĞ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ñ€ĞµĞ¹Ğ´ĞµÑ€Ğ°
 * 
 * ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ğµ: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… ÑĞ´ĞµĞ»Ğ¾Ğº, Ğ° Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… 50
 */

import axios from 'axios';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
  // ĞÑ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Polymarket Data API
  POLYMARKET_API_BASE: 'https://data-api.polymarket.com',
  
  // Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ñ‹
  TIMEOUT: 30000,
  
  // Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
  LIMIT_PER_REQUEST: 50,  // API Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 50 Ğ·Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
  MAX_OFFSET: 100000,     // ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ offset Ğ² API
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¢Ğ˜ĞŸĞ« Ğ”ĞĞĞĞ«Ğ¥ Ğ”Ğ›Ğ¯ POLYMARKET DATA API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface ClosedPosition {
  user: string;
  conditionId: string;
  tokenId: string;
  outcomeIndex: number;
  positionId: string;
  realizedPnl: string | null;  // Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ñ Ğ´ĞµÑÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "-0.15")
  percentRealizedPnl: string | null;
  totalCost: string | null;
  balance: string;
  createdAt: string;
  updatedAt: string;
}

interface ActivityItem {
  id: string;
  user: string;
  timestamp: string;
  type: 'trade' | 'split' | 'merge' | 'redeem' | 'reward' | 'conversion';
  conditionId?: string;
  cashAmount?: string;  // Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ² USDC (1e6 = $1)
  tokenAmount?: string; // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² (1e18 = 1 Ñ‚Ğ¾ĞºĞµĞ½)
  side?: 'buy' | 'sell';
  txHash?: string;
}

interface PositionResult {
  positionId: string;
  invested: number;     // Ğ² USD ($)
  payout: number;       // Ğ² USD ($)
  profitLoss: number;   // Ğ² USD ($)
  roi: number;          // ROI Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ°Ñ…
  realizedPnl: number;  // Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ P&L Ğ² USD ($)
  outcome: 'WIN' | 'LOSS' | 'PENDING';
  status: 'closed';
}

interface WinRateMetrics {
  totalClosedPositions: number;
  wins: number;
  losses: number;
  winRate: number;
  totalInvested: number;
  totalProfit: number;
  totalLoss: number;
  netPnl: number;
  averageWinSize: number;
  averageLossSize: number;
  largestWin: number;
  largestLoss: number;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Logger {
  info(msg: string) { console.log(`â„¹ï¸  ${msg}`); }
  success(msg: string) { console.log(`âœ… ${msg}`); }
  error(msg: string) { console.error(`âŒ ${msg}`); }
  warn(msg: string) { console.warn(`âš ï¸  ${msg}`); }
}

const log = new Logger();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLYMARKET DATA API Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function fetchFromDataAPI(endpoint: string, params: any): Promise<any[]> {
  try {
    const url = `${CONFIG.POLYMARKET_API_BASE}${endpoint}`;
    
    const response = await axios.get(url, {
      params,
      timeout: CONFIG.TIMEOUT,
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'Polymarket-Analyzer/2.0'
      }
    });

    if (!response.data || !Array.isArray(response.data)) {
      log.warn(`API Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ½ĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ${endpoint}`);
      return [];
    }

    return response.data;
  } catch (error: any) {
    if (error.response?.status === 404) {
      log.warn(`Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ ${endpoint} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ (404).`);
    } else {
      log.error(`API Error: ${endpoint} - ${error.message}`);
    }
    return [];
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ• Ğ’Ğ¡Ğ•Ğ¥ Ğ—ĞĞšĞ Ğ«Ğ¢Ğ«Ğ¥ ĞŸĞĞ—Ğ˜Ğ¦Ğ˜Ğ™ Ğ¡ ĞŸĞĞ“Ğ˜ĞĞĞ¦Ğ˜Ğ•Ğ™
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function getAllClosedPositions(walletAddress: string): Promise<ClosedPosition[]> {
  log.info(`ğŸ“Š Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ’Ğ¡Ğ• Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°: ${walletAddress}`);
  log.info(`   Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸...`);
  
  const allPositions: ClosedPosition[] = [];
  let offset = 0;
  let batchNumber = 1;
  let hasMoreData = true;

  try {
    while (hasMoreData && offset <= CONFIG.MAX_OFFSET) {
      log.info(`   ğŸ“„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ±Ğ°Ñ‚Ñ‡ ${batchNumber} (offset: ${offset})...`);
      
      const positions = await fetchFromDataAPI('/closed-positions', {
        user: walletAddress.toLowerCase(),
        limit: CONFIG.LIMIT_PER_REQUEST,
        offset: offset
      });

      if (positions.length === 0) {
        // Ğ•ÑĞ»Ğ¸ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¾ÑÑŒ, Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ»Ğ¸ ĞºĞ¾Ğ½Ñ†Ğ°
        hasMoreData = false;
        log.info(`   âœ“ ĞšĞ¾Ğ½ĞµÑ† Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚.`);
      } else {
        allPositions.push(...positions);
        log.success(`   âœ“ Ğ‘Ğ°Ñ‚Ñ‡ ${batchNumber}: Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ ${positions.length} Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ (Ğ²ÑĞµĞ³Ğ¾: ${allPositions.length})`);
        
        // Ğ•ÑĞ»Ğ¸ Ğ±Ğ°Ñ‚Ñ‡ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ñ‡ĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚, ÑÑ‚Ğ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ±Ğ°Ñ‚Ñ‡
        if (positions.length < CONFIG.LIMIT_PER_REQUEST) {
          hasMoreData = false;
          log.info(`   âœ“ Ğ­Ñ‚Ğ¾ Ğ±Ñ‹Ğ» Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ±Ğ°Ñ‚Ñ‡ (Ğ¼ĞµĞ½ÑŒÑˆĞµ ${CONFIG.LIMIT_PER_REQUEST} Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹).`);
        }
        
        offset += CONFIG.LIMIT_PER_REQUEST;
        batchNumber++;
        
        // ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ°, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ API
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    }

    log.success(`\nâœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ’Ğ¡Ğ•Ğ“Ğ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹: ${allPositions.length}\n`);
    return allPositions;
    
  } catch (error) {
    log.error(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹: ${error}`);
    log.warn(`Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ Ğ´Ğ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸: ${allPositions.length}`);
    return allPositions;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞĞĞ›Ğ˜Ğ— Ğ”ĞĞĞĞ«Ğ¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function analyzeClosedPosition(position: ClosedPosition): PositionResult {
  // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
  const realizedPnl = position.realizedPnl ? parseFloat(position.realizedPnl) : 0;
  const totalCost = position.totalCost ? parseFloat(position.totalCost) : 0;
  
  // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¸Ğ½Ğ²ĞµÑÑ‚Ğ¸Ñ†Ğ¸Ğ¸ Ğ¸ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ñƒ
  const invested = Math.max(totalCost, 0);
  const payout = invested + realizedPnl;
  
  // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ROI
  const roi = invested > 0 ? (realizedPnl / invested) * 100 : 0;
  
  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´
  let outcome: 'WIN' | 'LOSS' | 'PENDING' = 'PENDING';
  
  if (realizedPnl > 0.001) { // Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆÑƒÑ Ğ¿Ğ¾Ğ³Ñ€ĞµÑˆĞ½Ğ¾ÑÑ‚ÑŒ
    outcome = 'WIN';
  } else if (realizedPnl < -0.001) {
    outcome = 'LOSS';
  } else {
    outcome = 'PENDING'; // Ğ‘ĞµĞ·ÑƒĞ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
  }

  return {
    positionId: position.positionId,
    invested,
    payout,
    profitLoss: realizedPnl,
    roi,
    realizedPnl,
    outcome,
    status: 'closed',
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ ĞĞ¡Ğ§Ğ•Ğ¢ ĞœĞ•Ğ¢Ğ Ğ˜Ğš
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calculateMetrics(positions: PositionResult[]): WinRateMetrics {
  if (positions.length === 0) {
    return {
      totalClosedPositions: 0,
      wins: 0,
      losses: 0,
      winRate: 0,
      totalInvested: 0,
      totalProfit: 0,
      totalLoss: 0,
      netPnl: 0,
      averageWinSize: 0,
      averageLossSize: 0,
      largestWin: 0,
      largestLoss: 0,
    };
  }

  const wins = positions.filter(p => p.outcome === 'WIN');
  const losses = positions.filter(p => p.outcome === 'LOSS');
  
  const winCount = wins.length;
  const lossCount = losses.length;
  const totalClosedPositions = positions.length;
  
  // Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ñ‹
  const totalInvested = positions.reduce((sum, p) => sum + p.invested, 0);
  const totalProfit = wins.reduce((sum, w) => sum + w.profitLoss, 0);
  const totalLoss = losses.reduce((sum, l) => sum + l.profitLoss, 0); // Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ
  const netPnl = totalProfit + totalLoss;
  
  // Win Rate
  const winRate = totalClosedPositions > 0 ? (winCount / totalClosedPositions) * 100 : 0;
  
  // Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
  const averageWinSize = winCount > 0 ? totalProfit / winCount : 0;
  const averageLossSize = lossCount > 0 ? totalLoss / lossCount : 0;
  
  // ĞĞ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹ÑˆĞ¸/Ğ¿Ñ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹ÑˆĞ¸
  const largestWin = wins.length > 0 ? Math.max(...wins.map(w => w.profitLoss)) : 0;
  const largestLoss = losses.length > 0 ? Math.min(...losses.map(l => l.profitLoss)) : 0;

  return {
    totalClosedPositions,
    wins: winCount,
    losses: lossCount,
    winRate,
    totalInvested,
    totalProfit,
    totalLoss,
    netPnl,
    averageWinSize,
    averageLossSize,
    largestWin,
    largestLoss,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ’Ğ«Ğ’ĞĞ” Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ĞĞ’
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function printResults(metrics: WinRateMetrics, positions: PositionResult[]): void {
  console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('               ğŸ“Š POLYMARKET ĞĞĞĞ›Ğ˜Ğ— Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ĞĞ’ (Ğ’Ğ¡Ğ• Ğ’Ğ Ğ•ĞœĞ¯)');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log('ğŸ¯ ĞĞ‘Ğ©ĞĞ¯ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ');
  console.log(`  Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹: ${metrics.totalClosedPositions}`);
  console.log(`  Ğ’Ñ‹Ğ¸Ğ³Ñ€Ñ‹ÑˆĞ¸:               ${metrics.wins}`);
  console.log(`  ĞŸÑ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹ÑˆĞ¸:              ${metrics.losses}`);
  console.log(`  Win Rate:               ${metrics.winRate.toFixed(2)}%`);
  console.log('');

  console.log('ğŸ’° Ğ¤Ğ˜ĞĞĞĞ¡ĞĞ’Ğ«Ğ• ĞŸĞĞšĞĞ—ĞĞ¢Ğ•Ğ›Ğ˜');
  console.log(`  ĞĞ±Ñ‰Ğ¸Ğµ Ğ¸Ğ½Ğ²ĞµÑÑ‚Ğ¸Ñ†Ğ¸Ğ¸:       $${metrics.totalInvested.toFixed(2)}`);
  console.log(`  ĞĞ±Ñ‰Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ:          $${metrics.totalProfit.toFixed(2)}`);
  console.log(`  ĞĞ±Ñ‰Ğ¸Ğ¹ ÑƒĞ±Ñ‹Ñ‚Ğ¾Ğº:           $${Math.abs(metrics.totalLoss).toFixed(2)}`);
  console.log(`  Ğ§Ğ¸ÑÑ‚Ğ°Ñ P&L:             $${metrics.netPnl.toFixed(2)}`);
  
  // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ROI Ğ¿Ğ¾ Ğ²ÑĞµĞ¼Ñƒ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ
  const portfolioROI = metrics.totalInvested > 0 
    ? (metrics.netPnl / metrics.totalInvested) * 100 
    : 0;
  console.log(`  Portfolio ROI:          ${portfolioROI.toFixed(2)}%`);
  console.log('');

  console.log('ğŸ“Š Ğ¡Ğ Ğ•Ğ”ĞĞ˜Ğ• ĞŸĞĞšĞĞ—ĞĞ¢Ğ•Ğ›Ğ˜');
  console.log(`  Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ:        $${metrics.averageWinSize.toFixed(2)}`);
  console.log(`  Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹Ñˆ:       $${Math.abs(metrics.averageLossSize).toFixed(2)}`);
  console.log(`  ĞšÑ€ÑƒĞ¿Ğ½ĞµĞ¹ÑˆĞ¸Ğ¹ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ:     $${metrics.largestWin.toFixed(2)}`);
  console.log(`  ĞšÑ€ÑƒĞ¿Ğ½ĞµĞ¹ÑˆĞ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ³Ñ€Ñ‹Ñˆ:    $${Math.abs(metrics.largestLoss).toFixed(2)}`);
  console.log('');

  // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹ (ÑĞ°Ğ¼Ñ‹Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğµ)
  if (positions.length > 0) {
    console.log('ğŸ“‹ ĞŸĞĞ¡Ğ›Ğ•Ğ”ĞĞ˜Ğ• 10 Ğ¡Ğ”Ğ•Ğ›ĞĞš');
    const recentPositions = positions.slice(0, Math.min(10, positions.length));
    
    recentPositions.forEach((position, index) => {
      const symbol = position.outcome === 'WIN' ? 'ğŸŸ¢' : 
                     position.outcome === 'LOSS' ? 'ğŸ”´' : 'âšª';
      
      console.log(`  ${symbol} ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ ${position.positionId.substring(0, 16)}... | ${position.outcome} | P&L: $${position.profitLoss.toFixed(2)} | ROI: ${position.roi.toFixed(1)}%`);
    });
  }

  console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  log.success('ĞĞ½Ğ°Ğ»Ğ¸Ğ· ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ“Ğ›ĞĞ’ĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function analyzeWallet(walletAddress: string): Promise<void> {
  try {
    console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('     ğŸ“Š POLYMARKET WIN RATE ANALYZER (Ğ’ĞµÑ€ÑĞ¸Ñ "Ğ’Ğ¡Ğ• Ğ’Ğ Ğ•ĞœĞ¯")');
    console.log('      Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Polymarket Data API Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    
    log.info(`ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ ĞºĞ¾ÑˆĞµĞ»ĞµĞº: ${walletAddress}`);
    log.info(`ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: ${new Date().toLocaleString()}\n`);

    // Ğ¨Ğ°Ğ³ 1: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ’Ğ¡Ğ• Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ (ÑĞ¾ Ğ²ÑĞµĞ¹ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹)
    const closedPositions = await getAllClosedPositions(walletAddress);

    if (closedPositions.length === 0) {
      log.warn('Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°');
      log.warn('Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:');
      log.warn('  1. ĞšĞ¾ÑˆĞµĞ»ĞµĞº Ğ½Ğµ ÑĞ¾Ğ²ĞµÑ€ÑˆĞ°Ğ» ÑĞ´ĞµĞ»Ğ¾Ğº Ğ½Ğ° Polymarket');
      log.warn('  2. Ğ’ÑĞµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ ĞµÑ‰Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹');
      log.warn('  3. ĞšĞ¾ÑˆĞµĞ»ĞµĞº Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚');
      return;
    }

    // Ğ¨Ğ°Ğ³ 2: ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
    log.info('ğŸ”„ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸...');
    const analyzedPositions = closedPositions.map(analyzeClosedPosition);

    // Ğ¨Ğ°Ğ³ 3: Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
    const metrics = calculateMetrics(analyzedPositions);

    // Ğ¨Ğ°Ğ³ 4: Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
    printResults(metrics, analyzedPositions);
    
  } catch (error: any) {
    log.error(`ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: ${error.message}`);
    process.exit(1);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¢ĞĞ§ĞšĞ Ğ’Ğ¥ĞĞ”Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const walletAddress = process.argv[2];

if (!walletAddress || walletAddress === '--help' || walletAddress === '-h') {
  console.log(`
ğŸš€ POLYMARKET WIN RATE ANALYZER (Ğ’ĞµÑ€ÑĞ¸Ñ "Ğ’Ğ¡Ğ• Ğ’Ğ Ğ•ĞœĞ¯")

Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
  npx ts-node analyzer_final_all_time.ts <WALLET_ADDRESS>
  
ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:
  npx ts-node analyzer_final_all_time.ts 0xDf8C0017dbb54A5A2b2670334088C8fdEd6ccb40

ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:
  Ğ­Ñ‚Ğ¾Ñ‚ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ğ’Ğ¡Ğ• Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ (Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ) Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° 
  ÑĞ¾ Ğ²ÑĞµĞ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»Ğ¸ Ğ½Ğ° Polymarket, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Polymarket Data API.

ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾Ñ‚ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ²ĞµÑ€ÑĞ¸Ğ¹:
  âœ“ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ Ğ’Ğ¡Ğ• Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸, Ğ° Ğ½Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 50
  âœ“ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸
  âœ“ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ win rate Ğ·Ğ° Ğ’Ğ¡Ğ• Ğ²Ñ€ĞµĞ¼Ñ Ñ‚Ñ€ĞµĞ¹Ğ´ĞµÑ€Ğ°
  âœ“ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ ROI Ğ¿Ğ¾ Ğ²ÑĞµĞ¼Ñƒ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ

ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:
  â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚: ${CONFIG.POLYMARKET_API_BASE}
  â€¢ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ (Ğ³Ğ´Ğµ Ğ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½ realizedPnl)
  â€¢ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ² USD
  â€¢ Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ÑƒÑ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾ wins/losses

Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸:
  â€¢ Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚: /closed-positions (Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ limit + offset)
  â€¢ ĞĞµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ API ĞºĞ»ÑÑ‡ĞµĞ¹
  â€¢ Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Polymarket
  â€¢ ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ offset: ${CONFIG.MAX_OFFSET}
  `);
  process.exit(0);
}

// Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ°Ğ´Ñ€ĞµÑĞ° ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°
const ethAddressRegex = /^0x[a-fA-F0-9]{40}$/;
if (!ethAddressRegex.test(walletAddress)) {
  log.error(`ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ°Ğ´Ñ€ĞµÑĞ° ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°: ${walletAddress}`);
  log.error('ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ 0x... (40 hex ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)');
  process.exit(1);
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
analyzeWallet(walletAddress).catch((error) => {
  log.error(`ĞĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: ${error}`);
  process.exit(1);
});
